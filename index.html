<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Workout">
  <title>Workout Tracker</title>
  <style>
    *{-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0f172a;color:#fff;min-height:100vh;padding-bottom:100px;overscroll-behavior:none}
    .header{position:sticky;top:0;background:rgba(15,23,42,.95);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);z-index:10;padding:16px;padding-top:max(16px,env(safe-area-inset-top))}
    .header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .header h1{font-size:24px;font-weight:700}
    .header-buttons{display:flex;gap:12px}
    .header-btn{background:none;border:none;font-size:14px;font-weight:500;cursor:pointer;padding:8px 4px}
    .header-btn.tips{color:#fbbf24}.header-btn.history{color:#60a5fa}
    .workout-tabs{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px}
    .workout-tab{padding:10px;border-radius:12px;font-weight:600;border:none;cursor:pointer;transition:all .2s;font-size:14px}
    .workout-tab.active{background:#2563eb;color:#fff;box-shadow:0 4px 12px rgba(37,99,235,.3)}
    .workout-tab:not(.active){background:#1e293b;color:#94a3b8}
    .progress-container{background:#1e293b;border-radius:999px;height:12px;overflow:hidden}
    .progress-bar{height:100%;background:linear-gradient(to right,#3b82f6,#22c55e);transition:width .3s}
    .progress-text{text-align:center;color:#94a3b8;font-size:12px;margin-top:4px}
    .workout-info{padding:12px 16px}
    .workout-info h2{font-size:20px;font-weight:700}
    .workout-info .subtitle{color:#94a3b8;font-size:14px}
    .workout-info .variant{color:#60a5fa;font-size:12px;margin-top:4px}
    .exercises{padding:0 16px}
    .superset-group{border:1px solid #334155;border-radius:14px;padding:4px;margin-bottom:12px;position:relative}
    .superset-label{position:absolute;top:-10px;left:16px;background:#0f172a;color:#f59e0b;font-size:11px;font-weight:600;padding:2px 8px;border-radius:4px;letter-spacing:.5px;text-transform:uppercase}
    .superset-group .exercise-card{margin-bottom:4px}
    .superset-group .exercise-card:last-child{margin-bottom:0}
    .exercise-card{background:#1e293b;border-radius:12px;padding:16px;margin-bottom:12px;box-shadow:0 4px 12px rgba(0,0,0,.2)}
    .exercise-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
    .exercise-title-row{display:flex;align-items:center;gap:8px}
    .exercise-name{font-size:18px;font-weight:600}
    .tip-btn{width:24px;height:24px;border-radius:50%;background:#334155;border:none;color:#60a5fa;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
    .exercise-sets-reps{color:#60a5fa;font-size:14px}
    .exercise-meta{text-align:right}
    .exercise-rest{color:#94a3b8;font-size:12px;cursor:pointer;border-bottom:1px dashed #475569}
    .exercise-progress{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;margin-top:4px}
    .exercise-progress.complete{background:#16a34a;color:#fff}
    .exercise-progress:not(.complete){background:#334155;color:#cbd5e1}
    .exercise-note{color:#fbbf24;font-size:12px;font-style:italic;margin-bottom:12px}
    .previous-note{color:#60a5fa;font-size:12px;margin-bottom:8px}
    .previous-note .autofill-hint{color:#94a3b8;font-size:11px}
    .sets-header{display:grid;grid-template-columns:32px 1fr 1fr;gap:8px;color:#94a3b8;font-size:12px;padding:0 4px;margin-bottom:8px}
    .sets-header span:not(:first-child){text-align:center}
    .set-row{display:grid;grid-template-columns:32px 1fr 1fr;gap:8px;margin-bottom:8px;align-items:center}
    .set-number{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:500;cursor:pointer;transition:all .15s;user-select:none;-webkit-user-select:none}
    .set-number.complete{background:#16a34a;color:#fff}
    .set-number:not(.complete){background:#334155;color:#cbd5e1}
    .set-number.has-previous:not(.complete){border:1px dashed #60a5fa}
    .set-number.has-previous:not(.complete):active{transform:scale(.9)}
    .set-input{width:100%;padding:12px 8px;text-align:center;font-size:16px;background:#334155;border:1px solid #475569;border-radius:8px;color:#fff;outline:none}
    .set-input:focus{border-color:#3b82f6;box-shadow:0 0 0 2px rgba(59,130,246,.3)}
    .set-input::placeholder{color:#64748b}
    .set-input.has-previous::placeholder{color:#60a5fa}
    .rest-timer{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#1e293b;border:1px solid #334155;border-radius:16px;padding:12px 20px;display:flex;align-items:center;gap:14px;z-index:20;box-shadow:0 8px 32px rgba(0,0,0,.5);opacity:0;visibility:hidden;transition:all .25s}
    .rest-timer.active{opacity:1;visibility:visible}
    .rest-timer-display{font-size:28px;font-weight:700;font-variant-numeric:tabular-nums;min-width:56px;text-align:center}
    .rest-timer-label{color:#94a3b8;font-size:12px}
    .rest-timer-btns{display:flex;gap:8px}
    .rest-timer-btn{width:36px;height:36px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px}
    .rest-timer-btn.skip{background:#334155;color:#cbd5e1}
    .rest-timer-btn.add{background:#334155;color:#60a5fa;font-size:13px;font-weight:600}
    .rest-timer.done .rest-timer-display{color:#22c55e}
    .bottom-bar{position:fixed;bottom:0;left:0;right:0;background:rgba(30,41,59,.95);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border-top:1px solid #334155;padding:16px;padding-bottom:max(16px,env(safe-area-inset-bottom));display:flex;gap:12px;z-index:15}
    .clear-btn{padding:14px 20px;background:#334155;color:#cbd5e1;border:none;border-radius:12px;font-weight:500;cursor:pointer;font-size:16px}
    .finish-btn{flex:1;padding:14px;background:#16a34a;color:#fff;border:none;border-radius:12px;font-weight:600;cursor:pointer;font-size:16px;box-shadow:0 4px 12px rgba(22,163,74,.3)}
    .undo-toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:#334155;color:#fff;padding:12px 20px;border-radius:12px;font-size:14px;display:flex;align-items:center;gap:12px;z-index:25;box-shadow:0 8px 24px rgba(0,0,0,.4);opacity:0;visibility:hidden;transition:all .25s}
    .undo-toast.active{opacity:1;visibility:visible}
    .undo-toast button{background:#2563eb;color:#fff;border:none;padding:6px 14px;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:50;display:flex;align-items:flex-end;justify-content:center;opacity:0;visibility:hidden;transition:all .2s}
    .modal-overlay.active{opacity:1;visibility:visible}
    .modal{background:#1e293b;width:100%;max-width:500px;max-height:85vh;border-radius:16px 16px 0 0;display:flex;flex-direction:column;transform:translateY(100%);transition:transform .3s}
    .modal-overlay.active .modal{transform:translateY(0)}
    .modal-header{padding:16px;border-bottom:1px solid #334155;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
    .modal-header h2{font-size:20px;font-weight:700}
    .modal-close{width:40px;height:40px;border-radius:50%;background:#334155;border:none;color:#fff;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .modal-body{padding:16px;overflow-y:auto;flex:1;-webkit-overflow-scrolling:touch}
    .modal-footer{padding:16px;border-top:1px solid #334155;flex-shrink:0}
    .modal-footer button{width:100%;padding:14px;background:#2563eb;color:#fff;border:none;border-radius:12px;font-weight:600;font-size:16px;cursor:pointer}
    .tip-meta{color:#60a5fa;font-size:14px;margin-bottom:16px}
    .tip-section{background:#334155;border-radius:8px;padding:14px;margin-bottom:10px}
    .tip-section h3{font-size:13px;font-weight:600;margin-bottom:8px}
    .tip-section.setup h3{color:#60a5fa}
    .tip-section.execution h3{color:#22c55e}
    .tip-section.mistakes h3{color:#f87171}
    .tip-section p,.tip-section ul{color:#cbd5e1;font-size:14px;line-height:1.6}
    .tip-section ul{list-style:none;margin-top:4px}
    .tip-section ul li{padding:3px 0;padding-left:16px;position:relative}
    .tip-section ul li::before{content:"✗";position:absolute;left:0;color:#f87171;font-size:12px}
    .technique-card{background:#334155;border-radius:12px;padding:16px;margin-bottom:12px}
    .technique-card h3{color:#60a5fa;font-weight:600;margin-bottom:8px}
    .technique-card p{color:#cbd5e1;font-size:14px;margin-bottom:12px;line-height:1.5}
    .technique-example{background:#475569;border-radius:8px;padding:12px}
    .technique-example .label{color:#fbbf24;font-size:12px;font-weight:500;margin-bottom:4px}
    .technique-example p{margin:0;font-size:12px}
    .progression-card{background:#334155;border-radius:12px;padding:16px}
    .progression-card h3{color:#22c55e;font-weight:600;margin-bottom:8px}
    .progression-card ul{list-style:none}
    .progression-card li{color:#cbd5e1;font-size:14px;padding:6px 0}
    .progression-card li::before{content:"• "}
    .history-empty{color:#94a3b8;text-align:center;padding:32px}
    .history-entry{background:#334155;border-radius:8px;padding:12px;margin-bottom:12px}
    .history-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
    .history-workout{color:#fff;font-weight:500}
    .history-date{color:#94a3b8;font-size:14px}
    .history-variant{color:#60a5fa;font-size:12px;margin-bottom:8px}
    .history-exercise{padding:4px 0}
    .history-exercise-header{display:flex;justify-content:space-between}
    .history-exercise-name{color:#cbd5e1;font-size:12px}
    .history-exercise-sets{color:#22c55e;font-size:12px}
    .history-exercise-data{color:#64748b;font-size:12px}
    .history-delete-btn{background:none;border:none;color:#64748b;font-size:16px;cursor:pointer;padding:4px 8px;border-radius:6px}
    .history-delete-btn:active{color:#f87171}
    .finish-summary-header{text-align:center;margin-bottom:16px}
    .finish-summary-header .emoji{font-size:48px;margin-bottom:8px}
    .finish-summary-header h3{font-size:20px;font-weight:700}
    .finish-summary-header p{color:#94a3b8;font-size:14px;margin-top:4px}
    .finish-stat-row{display:flex;gap:8px;margin-bottom:12px}
    .finish-stat{flex:1;background:#334155;border-radius:10px;padding:12px;text-align:center}
    .finish-stat .value{font-size:22px;font-weight:700;color:#22c55e}
    .finish-stat .label{font-size:11px;color:#94a3b8;margin-top:2px}
    .finish-exercise-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #334155}
    .finish-exercise-item:last-child{border-bottom:none}
    .finish-exercise-name{color:#cbd5e1;font-size:14px}
    .finish-exercise-detail{color:#22c55e;font-size:14px}
    .finish-next{background:#334155;border-radius:10px;padding:12px;text-align:center;margin-top:12px}
    .finish-next .label{color:#94a3b8;font-size:12px}
    .finish-next .value{color:#60a5fa;font-weight:600;margin-top:2px}
    .finish-footer-btns{display:flex;gap:10px}
    .finish-footer-btns button{flex:1}
    .finish-footer-btns .cancel-btn{background:#334155;color:#cbd5e1}
    .finish-footer-btns .confirm-btn{background:#16a34a}
  </style>
</head>
<body>
  <div class="header">
    <div class="header-top">
      <h1>Workout Tracker</h1>
      <div class="header-buttons">
        <button class="header-btn tips" id="tipsBtn">Tips</button>
        <button class="header-btn history" id="historyBtn">History</button>
      </div>
    </div>
    <div class="workout-tabs" id="workoutTabs"></div>
    <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
    <p class="progress-text" id="progressText">0 / 0 sets</p>
  </div>
  <div class="workout-info" id="workoutInfo"></div>
  <div class="exercises" id="exercisesList"></div>
  <div class="rest-timer" id="restTimer">
    <div>
      <div class="rest-timer-display" id="restTimerDisplay">0:00</div>
      <div class="rest-timer-label" id="restTimerLabel">Rest</div>
    </div>
    <div class="rest-timer-btns">
      <button class="rest-timer-btn add" id="restTimerAdd">+30</button>
      <button class="rest-timer-btn skip" id="restTimerSkip">✕</button>
    </div>
  </div>
  <div class="undo-toast" id="undoToast"><span>Workout cleared</span><button id="undoBtn">Undo</button></div>
  <div class="bottom-bar">
    <button class="clear-btn" id="clearBtn">Clear</button>
    <button class="finish-btn" id="finishBtn">Finish Workout ✓</button>
  </div>
  <div class="modal-overlay" id="tipModal"><div class="modal"><div class="modal-header"><h2 id="tipModalTitle">Exercise</h2><button class="modal-close" id="tipModalClose">×</button></div><div class="modal-body" id="tipModalBody"></div><div class="modal-footer"><button id="tipModalCloseBtn">Close</button></div></div></div>
  <div class="modal-overlay" id="techniquesModal"><div class="modal"><div class="modal-header"><h2>Training Techniques</h2><button class="modal-close" id="techniquesModalClose">×</button></div><div class="modal-body" id="techniquesModalBody"></div><div class="modal-footer"><button id="techniquesModalCloseBtn">Close</button></div></div></div>
  <div class="modal-overlay" id="historyModal"><div class="modal"><div class="modal-header"><h2>Workout History</h2><button class="modal-close" id="historyModalClose">×</button></div><div class="modal-body" id="historyModalBody"></div><div class="modal-footer"><button id="historyModalCloseBtn">Close</button></div></div></div>
  <div class="modal-overlay" id="finishModal"><div class="modal"><div class="modal-header"><h2>Workout Complete</h2><button class="modal-close" id="finishModalClose">×</button></div><div class="modal-body" id="finishModalBody"></div><div class="modal-footer"><div class="finish-footer-btns"><button class="cancel-btn" id="finishCancelBtn">Cancel</button><button class="confirm-btn" id="finishConfirmBtn">Save Workout</button></div></div></div></div>
  <script>
    const workoutData = {
      A: {
        name: "UPPER", subtitle: "Chest / Back / Arms", variant: "Push / Pull / Arms",
        exercises: [
          { id: 'a1-incline', name: 'Incline DB Press', sets: 3, reps: '8-10', rest: 90, restLabel: '90s', note: 'Primary press variation',
            tip: {
              setup: 'Set the bench to 30° (one or two notches up). Sit down with the dumbbells on your thighs, then use your knees to kick them up one at a time as you lean back. Plant your feet flat on the floor, retract and depress your shoulder blades (pull them back and down), and maintain a slight natural arch in your lower back.',
              execution: 'Start with the dumbbells at chest level, elbows at roughly 45° from your torso (not flared out to 90°). Press up in a slight arc so the dumbbells converge toward each other at the top without clanking. At lockout, your arms should be directly over your upper chest. Lower under control over 2–3 seconds, feeling a stretch across the upper chest at the bottom.\n\nInhale as you lower; exhale forcefully through the sticking point as you press.',
              mistakes: ['Bench set too steep (45°+) — shifts work to the front delts.', 'Flaring elbows to 90° — increases shoulder impingement risk.', 'Bouncing at the bottom or losing shoulder blade retraction.', 'Over-arching the lower back to compensate for too-heavy weight.']
            }
          },
          { id: 'a2', name: 'Chest Supported Machine Row', sets: 3, reps: '8-10 + 1 RP', rest: 90, restLabel: '90s', note: 'Rest-Pause on final set',
            tip: {
              setup: 'Adjust the seat height and chest pad so your chest is firmly supported and the handles are at roughly lower-chest level. Plant your feet flat on the floor or foot plates. Grip the handles with your preferred grip (neutral, pronated, or whatever the machine offers). Start with arms extended and let your shoulder blades protract forward for a full stretch.',
              execution: 'Initiate the pull by retracting your shoulder blades (squeezing them together), then drive your elbows back toward your hips. Think "elbows to back pockets" rather than pulling with your hands. At the top, squeeze the contraction for a full second. Lower under control over 2–3 seconds, allowing your shoulder blades to protract (spread apart) at the bottom for a full stretch.\n\nRest-Pause (final set only): Perform reps to technical failure. Stay in position, rest 10–15 seconds while breathing deeply, then do as many additional reps as possible with good form.',
              mistakes: ['Lifting your chest off the pad (using momentum).', 'Pulling too high — row to your lower ribs/upper hip, not to your armpits.', 'Shrugging your shoulders up toward your ears; keep them depressed.', 'Cutting the range of motion short at the bottom — the stretched position is where a large portion of growth stimulus occurs.']
            }
          },
          { id: 'a3', name: 'Lat Pulldown', sets: 3, reps: '10-12', rest: 90, restLabel: '90s', note: 'Focus on the stretch',
            tip: {
              setup: 'Adjust the thigh pad so it locks you in snugly. Grip the bar about 1.5× shoulder width with an overhand (pronated) grip. Start with your arms fully extended overhead, allowing your lats to stretch completely.',
              execution: 'Lean back approximately 15–20°. Initiate the pull by depressing your shoulder blades (pulling them downward), then drive your elbows down and slightly back toward your hip bones. Pull the bar to your upper chest/collarbone area. Squeeze your lats briefly at the bottom.\n\nOn the way up, control the bar and allow your shoulders to fully elevate and your lats to stretch completely at the top before starting the next rep. Don\'t cut the range of motion short — the loaded stretch is a powerful growth stimulus.',
              mistakes: ['Pulling behind the neck — places the shoulder in a vulnerable position with no additional lat activation.', 'Using excessive body momentum by rocking back and forth.', 'Gripping too wide — past 1.5× shoulder width actually reduces lat ROM.', 'Not fully extending at the top — you lose the most valuable part of the rep.', 'Pulling with your biceps; focus on the "elbows to hips" cue.']
            }
          },
          { id: 'a4-curl', name: 'Cable Curl', sets: 3, reps: '10-12', rest: 0, restLabel: '0s', note: 'SUPERSET with Pushdown', superset: 'curl-push',
            tip: {
              setup: 'Attach a straight bar or EZ bar to a low cable pulley. Stand about 1–2 steps back from the machine (not directly over the pulley) — this creates an angled cable line that pulls your arms slightly behind your torso at the bottom, maximizing tension on the biceps in their lengthened position. Even if you are shorter, stepping back ensures the cable is not pulling straight down (which would feel like zero tension at the bottom). Feet shoulder-width apart, grip underhand (supinated), hands about shoulder-width.',
              execution: 'Keeping your upper arms locked at your sides (elbows pinned to your ribs), curl the bar up toward your shoulders. Squeeze your biceps hard at the top for a brief pause. Lower under control over 2–3 seconds, fully extending your arms at the bottom.\n\nImmediately switch to Cable Pushdowns.',
              mistakes: ['Swinging the weight — if your torso rocks, the weight is too heavy.', 'Letting your elbows drift forward as you curl — shifts tension to front delts.', 'Cutting the rep short at the bottom — fully extend to load the biceps in their lengthened position.', 'Curling your wrists inward; keep them straight and in line with your forearms.']
            }
          },
          { id: 'a4-push', name: 'Cable Pushdown', sets: 3, reps: '10-12', rest: 60, restLabel: '60s', note: 'SUPERSET with Cable Curl', superset: 'curl-push',
            tip: {
              setup: 'Attach a straight bar, V-bar, or rope to the high pulley. Stand facing the machine, feet shoulder-width apart or in a slight stagger. Grip with an overhand grip (palms down for bar; neutral for rope). Start with elbows bent at about 90° and tucked tightly against your sides.',
              execution: 'Keeping your elbows pinned to your sides and upper arms stationary, extend your forearms downward until your arms are fully straight. Squeeze your triceps hard at full lockout. With the rope, spread the ends apart at the bottom for a stronger contraction. Reverse under control, stopping when your forearms reach roughly parallel to the floor.\n\nRest 60 seconds after the pushdown, then repeat the superset.',
              mistakes: ['Leaning over the bar and pressing down with your bodyweight — stand upright.', 'Flaring elbows out to the sides — recruits chest and shoulders.', 'Letting the weight "snap" your arms back up — control the eccentric.', 'Using too heavy a load, causing your whole body to rock.']
            }
          },
          { id: 'a5', name: 'Overhead Extension', sets: 3, reps: '12-15', rest: 60, restLabel: '60s', note: 'Myoreps if over 45 min',
            tip: {
              setup: 'Use a rope or straight bar attachment on a cable machine (pulley at roughly waist to head height — not the floor). The rope allows greater ROM and a more natural wrist path; a bar allows heavier loading and a fixed, stable path — both work well. Face away from the machine with one foot forward for stability. Extend your arms overhead with your elbows close to your ears.',
              execution: 'Keeping your upper arms stationary and close to your head, lower the weight behind your head by bending at the elbows. Go deep — feel a full stretch in the long head of the triceps. Then extend your arms back up, squeezing your triceps at the top.\n\nMyoreps option (use if short on time): Perform 12–15 reps to near failure. Take 3–5 deep breaths (~10–15 sec), then do 3–5 more reps. Breathe again, do another mini-set, and repeat until you can\'t complete at least 3 reps.',
              mistakes: ['Flaring your elbows out wide — keep them pointed forward and close to your head.', 'Using your shoulders to press the weight; only your forearms should move.', 'Not going deep enough — a partial ROM defeats the purpose of choosing an overhead position.', 'Arching your lower back excessively; brace your core or use a seated position.']
            }
          },
          { id: 'a6-pec', name: 'Pec Deck', sets: 3, reps: '12-15', rest: 0, restLabel: '0s', note: 'SUPERSET with Rear Delt Fly', superset: 'pec-rear',
            tip: {
              setup: 'Adjust the seat height so the handles align with mid-chest level. Sit with your back flat against the pad. Grip the handles with your elbows slightly bent — maintain this same elbow angle throughout.',
              execution: 'Bring the handles together in front of your chest in a controlled hugging motion, squeezing your pecs hard when the handles are closest together. Hold the peak contraction for 1–2 seconds. Reverse the motion slowly (2–3 seconds), allowing a deep stretch across the chest. Stop just before the weight stack touches down to keep constant tension.\n\nMove immediately to Rear Delt Fly.',
              mistakes: ['Letting your shoulders roll forward — keep shoulder blades in contact with the pad.', 'Straightening your arms (turns it into a front delt exercise).', 'Using momentum or slamming the handles together.', 'Going too heavy and reducing range of motion — lighter weight with full ROM and a squeeze beats heavy partial reps.']
            }
          },
          { id: 'a6-rear', name: 'Rear Delt Fly', sets: 3, reps: '12-15', rest: 60, restLabel: '60s', note: 'SUPERSET with Pec Deck', superset: 'pec-rear',
            tip: {
              setup: 'Turn around on the pec deck machine. Sit facing the pad with your chest pressed against it. Adjust the handles to the widest starting position. Grip the handles with arms extended in front of you with a slight bend at the elbows.',
              execution: 'With your elbows slightly bent and wrists neutral, pull the handles back in a wide arc by squeezing your rear delts and mid-back. Think about leading with your elbows and pinching your shoulder blades together. Hold the contraction at the end for 1–2 seconds. Return the handles forward slowly and under control.\n\nRest 60 seconds after the rear delt fly, then repeat the superset.',
              mistakes: ['Using too much weight and turning it into a traps/rhomboid-dominant shrug.', 'Lifting your chest off the pad (using body momentum).', 'Bending your elbows more as you pull (turns it into a row).', 'Letting your wrists go limp — keep them in line with your forearms.']
            }
          },
        ]
      },
      B1: {
        name: "LOWER + SHOULDERS", subtitle: "Legs / Delts / Biceps", variant: "Squat / Leg Curl",
        exercises: [
          { id: 'b1-squat', name: 'Barbell Squat', sets: 3, reps: '6-8', rest: 120, restLabel: '2 min', note: 'Primary leg variation',
            tip: {
              setup: 'Position the bar on your upper traps (high bar) or across your rear delts below the spine of the scapula (low bar). Grip the bar just outside shoulder width. Unrack by standing up with both legs under you, then take 2–3 deliberate steps back. Set your feet roughly shoulder-width apart or slightly wider, toes pointed out 15–30°.',
              execution: 'Take a deep breath into your belly and brace your core hard (Valsalva maneuver — imagine bracing for a punch). Break at the hips and knees simultaneously. Your knees should track over your toes (it\'s fine for them to go past your toes). Descend until your hip crease is at or below your kneecap (parallel or deeper). Drive through your full foot to stand back up. Exhale through the sticking point or at the top. Re-breathe between reps.\n\nDeeper squats (at least to parallel) produce greater quad and glute activation than partials, even with heavier loads. If you can\'t hit parallel, reduce weight or work on ankle/hip mobility.',
              mistakes: ['"Butt wink" (pelvis tucking under at the bottom) — usually caused by insufficient hip mobility. Only go as deep as you can maintain a neutral spine.', 'Knees caving inward — actively push your knees out over your toes.', 'Rising hips faster than chest ("good morning squat") — keep chest up and drive traps into the bar.', 'Shifting onto your toes — keep weight distributed over your whole foot.']
            }
          },
          { id: 'b2', name: 'Cable Lateral Raise', sets: 4, reps: '15-20', rest: 60, restLabel: '60s', note: 'High reps for pump & width',
            tip: {
              setup: 'Set the cable pulley to roughly hip or hand height (not the floor) — this loads the delt hardest in its stretched position. Stand sideways to the machine and grab the handle with your outside hand. The cable should cross in front of your body. Stand tall with your working arm hanging relaxed across your body, feeling a stretch on the side delt.',
              execution: 'With a slight bend in your elbow (maintain throughout), raise your arm out to the side until your hand reaches roughly ear height. Lead with your elbow rather than your hand. At the top, pause briefly. Lower under control over 2–3 seconds. Do all reps on one side, then switch.',
              mistakes: ['Shrugging your traps — keep your shoulder down and away from your ear. If you\'re shrugging, the weight is too heavy.', 'Using momentum (swinging your body) — your torso should stay still.', 'Raising the arm too far past shoulder height — once the upper arm is above parallel, the traps take over.', 'Internally rotating at the top ("pouring the pitcher") — outdated cue that increases impingement risk. Keep your palm facing down or thumb slightly up.']
            }
          },
          { id: 'b2b', name: 'Overhead Extension', sets: 3, reps: '12-15', rest: 60, restLabel: '60s', note: 'Long head tricep focus',
            tip: {
              setup: 'Use a rope or straight bar attachment on a cable machine (pulley at roughly waist to head height — not the floor). The rope allows greater ROM and a more natural wrist path; a bar allows heavier loading and a fixed, stable path — both work well. Face away from the machine with one foot forward for stability. Extend your arms overhead with your elbows close to your ears.',
              execution: 'Keeping your upper arms stationary and close to your head, lower the weight behind your head by bending at the elbows. Go deep — feel a full stretch in the long head of the triceps. Then extend your arms back up, squeezing your triceps at the top.',
              mistakes: ['Flaring your elbows out wide — keep them pointed forward and close to your head.', 'Using your shoulders to press the weight; only your forearms should move.', 'Not going deep enough — a partial ROM defeats the purpose of choosing an overhead position.', 'Arching your lower back excessively; brace your core or use a seated position.']
            }
          },
          { id: 'b3', name: 'Machine Preacher Curl', sets: 3, reps: '10-12', rest: 60, restLabel: '60s', note: 'Bicep isolation',
            tip: {
              setup: 'Adjust the seat so your elbows and upper arms (triceps) are firmly planted on the pad and you can comfortably reach the handles at full arm extension. Your armpits don\'t need to touch the top of the pad — what matters is that your upper arms stay flat against it throughout every rep. Grip the handles underhand (supinated).',
              execution: 'Start with your arms fully extended — feel a clear stretch in your biceps. Curl the handles up toward your shoulders, squeezing your biceps hard at the top. Then lower under control, taking 2–3 seconds to return to full extension. Don\'t rush the descent — the stretched position at the bottom is where the growth stimulus is highest.',
              mistakes: ['Cutting the bottom short — the stretched position is the entire point of this exercise. Go all the way down every rep.', 'Lifting your upper arms off the pad during the curl (generates momentum and removes isolation).', 'Going too heavy and losing control at the bottom — a sudden drop under load can strain the biceps tendon. Always control the eccentric.', 'Stopping the curl too early at the top — full ROM means full elbow flexion.']
            }
          },
          { id: 'b4', name: 'Machine Shoulder Press', sets: 3, reps: '8-12', rest: 90, restLabel: '90s', note: 'Keep it heavy',
            tip: {
              setup: 'Adjust the seat so the handles start at shoulder height when seated. If the machine has an adjustable back angle, ~80° can be easier on the shoulders. Sit with your back firmly against the pad and feet flat on the floor.',
              execution: 'Press the handles overhead, extending your arms without slamming into full lockout. At the top, your hands should be roughly above your shoulders, not drifted forward. Lower under control until the handles return to shoulder level or slightly below — feel a stretch at the bottom of your delts. Don\'t let the weight stack slam down between reps.\n\nExhale on each press, inhale on each descent.',
              mistakes: ['Arching your lower back excessively to help press — if you need to arch, it\'s too heavy.', 'Not going low enough — aim for handles at or slightly below ear level at the bottom.', 'Locking out aggressively — straighten your arms but don\'t hyperextend.', 'Holding your breath for multiple reps.']
            }
          },
          { id: 'b5-curl', name: 'Seated Leg Curl', sets: 3, reps: '10-12', rest: 90, restLabel: '90s', note: 'Secondary leg variation',
            tip: {
              setup: 'Adjust the machine so the ankle pad rests just above your heels and your knees align with the machine pivot. Sit forward on the seat so you can lean your torso forward over the thigh pad rather than resting against the back support — this increases hip flexion and places the biarticular hamstrings under a greater stretch, which is the main hypertrophy advantage of the seated curl over lying variants (Maeo et al. 2021). If the machine has a ROM adjustment, set it to start from near-full extension.',
              execution: 'Curl your heels back and down toward the underside of your thighs by contracting your hamstrings. Squeeze hard at peak contraction for a full second. Then return to the start under control — take 2–3 seconds to extend your legs. The slow eccentric in the lengthened position is critical for hamstring growth.',
              mistakes: ['Lifting your thighs off the lap pad during the curl — reduces the effective stretch.', 'Using momentum to swing the weight — keep it smooth and controlled.', 'Not going to full extension at the top — the stretched position is where the growth stimulus is highest.', 'Rushing through reps — this exercise rewards slow, controlled tempo (2–3 sec eccentric).']
            }
          },
        ]
      },
      B2: {
        name: "LOWER + SHOULDERS", subtitle: "Legs / Delts / Biceps", variant: "RDL / Lunges",
        exercises: [
          { id: 'b1-rdl', name: 'Romanian Deadlift', sets: 3, reps: '6-8', rest: 120, restLabel: '2 min', note: 'Primary leg variation',
            tip: {
              setup: 'Stand with feet hip-width apart, holding a barbell with a double overhand grip (use straps if grip limits you — don\'t let grip cap your hamstring training). Bar starts at hip level, arms straight, shoulders back, chest up. Unlock your knees to a soft bend (~10–15°) and maintain this exact knee angle throughout.',
              execution: 'Push your hips straight back (imagine closing a car door with your butt) while keeping the bar in contact with or very close to your legs. Your torso will hinge forward as your hips travel backward. Lower until you feel a strong stretch in your hamstrings — usually around mid-shin. The exact depth depends on flexibility; stop before your lower back rounds. Drive your hips forward to stand up, squeezing your glutes to full lockout.\n\nThis is a hip hinge, not a squat. Your knees stay at the same slight bend — don\'t bend them more as you lower.',
              mistakes: ['Rounding your lower back — the #1 risk. If your back rounds, the weight is too heavy or you\'re going too deep.', 'Bending the knees more as you descend (turns it into a hybrid).', 'Letting the bar drift away from your body — more stress on your lower back.', 'Not going deep enough — push the hips back further if your hamstrings allow.', 'Hyperextending at the top — stand to neutral posture, don\'t lean back.']
            }
          },
          { id: 'b2', name: 'Cable Lateral Raise', sets: 4, reps: '15-20', rest: 60, restLabel: '60s', note: 'High reps for pump & width',
            tip: {
              setup: 'Set the cable pulley to roughly hip or hand height (not the floor) — this loads the delt hardest in its stretched position. Stand sideways to the machine and grab the handle with your outside hand. The cable should cross in front of your body. Stand tall with your working arm hanging relaxed across your body, feeling a stretch on the side delt.',
              execution: 'With a slight bend in your elbow (maintain throughout), raise your arm out to the side until your hand reaches roughly ear height. Lead with your elbow rather than your hand. At the top, pause briefly. Lower under control over 2–3 seconds. Do all reps on one side, then switch.',
              mistakes: ['Shrugging your traps — keep your shoulder down and away from your ear. If you\'re shrugging, the weight is too heavy.', 'Using momentum (swinging your body) — your torso should stay still.', 'Raising the arm too far past shoulder height — once the upper arm is above parallel, the traps take over.', 'Internally rotating at the top ("pouring the pitcher") — outdated cue that increases impingement risk. Keep your palm facing down or thumb slightly up.']
            }
          },
          { id: 'b2b', name: 'Overhead Extension', sets: 3, reps: '12-15', rest: 60, restLabel: '60s', note: 'Long head tricep focus',
            tip: {
              setup: 'Use a rope or straight bar attachment on a cable machine (pulley at roughly waist to head height — not the floor). The rope allows greater ROM and a more natural wrist path; a bar allows heavier loading and a fixed, stable path — both work well. Face away from the machine with one foot forward for stability. Extend your arms overhead with your elbows close to your ears.',
              execution: 'Keeping your upper arms stationary and close to your head, lower the weight behind your head by bending at the elbows. Go deep — feel a full stretch in the long head of the triceps. Then extend your arms back up, squeezing your triceps at the top.',
              mistakes: ['Flaring your elbows out wide — keep them pointed forward and close to your head.', 'Using your shoulders to press the weight; only your forearms should move.', 'Not going deep enough — a partial ROM defeats the purpose of choosing an overhead position.', 'Arching your lower back excessively; brace your core or use a seated position.']
            }
          },
          { id: 'b3', name: 'Machine Preacher Curl', sets: 3, reps: '10-12', rest: 60, restLabel: '60s', note: 'Bicep isolation',
            tip: {
              setup: 'Adjust the seat so your elbows and upper arms (triceps) are firmly planted on the pad and you can comfortably reach the handles at full arm extension. Your armpits don\'t need to touch the top of the pad — what matters is that your upper arms stay flat against it throughout every rep. Grip the handles underhand (supinated).',
              execution: 'Start with your arms fully extended — feel a clear stretch in your biceps. Curl the handles up toward your shoulders, squeezing your biceps hard at the top. Then lower under control, taking 2–3 seconds to return to full extension. Don\'t rush the descent — the stretched position at the bottom is where the growth stimulus is highest.',
              mistakes: ['Cutting the bottom short — the stretched position is the entire point of this exercise. Go all the way down every rep.', 'Lifting your upper arms off the pad during the curl (generates momentum and removes isolation).', 'Going too heavy and losing control at the bottom — a sudden drop under load can strain the biceps tendon. Always control the eccentric.', 'Stopping the curl too early at the top — full ROM means full elbow flexion.']
            }
          },
          { id: 'b4', name: 'Machine Shoulder Press', sets: 3, reps: '8-12', rest: 90, restLabel: '90s', note: 'Keep it heavy',
            tip: {
              setup: 'Adjust the seat so the handles start at shoulder height when seated. If the machine has an adjustable back angle, ~80° can be easier on the shoulders. Sit with your back firmly against the pad and feet flat on the floor.',
              execution: 'Press the handles overhead, extending your arms without slamming into full lockout. At the top, your hands should be roughly above your shoulders, not drifted forward. Lower under control until the handles return to shoulder level or slightly below — feel a stretch at the bottom of your delts. Don\'t let the weight stack slam down between reps.\n\nExhale on each press, inhale on each descent.',
              mistakes: ['Arching your lower back excessively to help press — if you need to arch, it\'s too heavy.', 'Not going low enough — aim for handles at or slightly below ear level at the bottom.', 'Locking out aggressively — straighten your arms but don\'t hyperextend.', 'Holding your breath for multiple reps.']
            }
          },
          { id: 'b5-lunge', name: 'Dumbbell Lunges', sets: 3, reps: '10-12 each leg', rest: 90, restLabel: '90s', note: 'Secondary leg variation',
            tip: {
              setup: 'Stand holding a dumbbell in each hand at your sides with a neutral grip. Feet start hip-width apart, chest up, shoulders back. Pick a spot to focus your eyes on at eye level — helps with balance.',
              execution: 'Step forward with one leg, taking a stride long enough that when you descend, both knees reach approximately 90°. Your front shin should be roughly vertical (knee over ankle). Lower your hips straight down until your back knee hovers 1–2 inches above the ground. Push through your front heel to drive back to the start. Alternate legs each rep, or do all reps on one side before switching.\n\nReverse lunges (stepping backward) are easier on the knees and more stable — a good option if forward lunges bother your knees.',
              mistakes: ['Stepping too short — pushes your front knee excessively past your toes.', 'Leaning your torso forward — stay upright with core braced.', 'Letting your back knee slam into the ground — control the descent.', 'Feet too narrow (tightrope) — keep feet roughly hip-width apart. Think railroad tracks, not balance beam.', 'Pushing off the back foot to return — the front leg should do the work.']
            }
          },
        ]
      }
    };
    const workoutRotation = ['A', 'B1', 'A', 'B2'];
    const techniques = [
      { name: 'Rest-Pause (RP)', description: 'A technique to extend a set beyond initial failure, accumulating more "effective reps" (the reps closest to failure that drive the most hypertrophy). Perform reps until you reach technical failure, rest 10–15 seconds while staying in position, then do as many more reps as possible.', example: 'If you get 8 reps, rest 10–15 sec, then get 3 more reps — nearly all 11 of those reps were "effective reps" near failure.' },
      { name: 'Myoreps', description: 'A time-efficient technique for isolation exercises. Do an activation set to near failure (12–15 reps), then take 3–5 deep breaths (~10–15 sec) and do 3–5 more reps. Because you\'re already fatigued, every rep in the mini-sets is an effective rep. Repeat until you can\'t get at least 3 reps.', example: 'Overhead extension: 15 reps → breathe → 5 reps → breathe → 4 reps → breathe → 3 reps. That\'s 27 total reps — nearly all effective — done in ~90 seconds.' },
      { name: 'Superset', description: 'Two exercises performed back-to-back with no rest between them. Rest only after both exercises. Most effective pairing opposing muscle groups (e.g., chest + back, biceps + triceps) so one recovers while the other works.', example: 'Pec Deck (15 reps) → immediately → Rear Delt Fly (15 reps) → rest 60s → repeat.' }
    ];
    const progressionTips = [
      'Add weight when you hit the top of the rep range for all sets with good form',
      'Increase by 5 lbs for upper body, 10 lbs for lower body compound lifts',
      'If you can\'t complete the minimum reps with good form, reduce the weight slightly',
      'Your previous weights show in blue — aim to match or beat them each session',
      'If you stall for 2+ sessions, try adding one extra rep per set before adding weight'
    ];

    let currentRotationIndex = 0, sessionLog = {}, history = [];
    let clearedBackup = null, undoTimeout = null, restTimerInterval = null, restTimeRemaining = 0;

    function init() { loadData(); renderWorkoutTabs(); renderWorkout(); renderTechniquesModal(); setupEventListeners(); }

    function loadData() {
      try {
        const h = localStorage.getItem('workoutHistory_v3');
        const s = localStorage.getItem('currentSession_v3');
        if (h) history = JSON.parse(h);
        if (s) { const d = JSON.parse(s); sessionLog = d.log || {}; currentRotationIndex = d.rotationIndex ?? 0; }
      } catch(e) {}
    }
    function saveSession() { try { localStorage.setItem('currentSession_v3', JSON.stringify({ rotationIndex: currentRotationIndex, log: sessionLog })); } catch(e) {} }
    function saveHistory() { try { localStorage.setItem('workoutHistory_v3', JSON.stringify(history)); } catch(e) {} }

    let restTimerEndTime = 0;
    function startRestTimer(seconds, force) {
      // Don't restart if timer is already running, unless forced (manual tap)
      if (!force && restTimerInterval && restTimeRemaining > 0) return;
      clearInterval(restTimerInterval);
      restTimeRemaining = seconds;
      restTimerEndTime = Date.now() + seconds * 1000;
      const timer = document.getElementById('restTimer'), display = document.getElementById('restTimerDisplay'), label = document.getElementById('restTimerLabel');
      timer.classList.add('active'); timer.classList.remove('done'); label.textContent = 'Rest';
      function tick() {
        restTimeRemaining = Math.round((restTimerEndTime - Date.now()) / 1000);
        if (restTimeRemaining <= 0) {
          restTimeRemaining = 0;
          clearInterval(restTimerInterval); restTimerInterval = null;
          timer.classList.add('done'); display.textContent = 'GO!'; label.textContent = 'Rest complete';
          if ('vibrate' in navigator) navigator.vibrate([200,100,200]);
          setTimeout(dismissRestTimer, 5000);
        } else {
          const m = Math.floor(restTimeRemaining / 60), s = restTimeRemaining % 60;
          display.textContent = `${m}:${s.toString().padStart(2,'0')}`;
        }
      }
      tick(); restTimerInterval = setInterval(tick, 1000);
    }
    function dismissRestTimer() { clearInterval(restTimerInterval); restTimerInterval = null; restTimeRemaining = 0; restTimerEndTime = 0; document.getElementById('restTimer').classList.remove('active','done'); }
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && restTimerEndTime > 0) {
        clearInterval(restTimerInterval);
        restTimeRemaining = Math.round((restTimerEndTime - Date.now()) / 1000);
        if (restTimeRemaining <= 0) {
          const timer = document.getElementById('restTimer');
          timer.classList.add('done');
          document.getElementById('restTimerDisplay').textContent = 'GO!';
          document.getElementById('restTimerLabel').textContent = 'Rest complete';
          if ('vibrate' in navigator) navigator.vibrate([200,100,200]);
          setTimeout(dismissRestTimer, 5000);
        } else {
          function tick() {
            restTimeRemaining = Math.round((restTimerEndTime - Date.now()) / 1000);
            if (restTimeRemaining <= 0) {
              restTimeRemaining = 0;
              clearInterval(restTimerInterval); restTimerInterval = null;
              const timer = document.getElementById('restTimer');
              timer.classList.add('done');
              document.getElementById('restTimerDisplay').textContent = 'GO!';
              document.getElementById('restTimerLabel').textContent = 'Rest complete';
              if ('vibrate' in navigator) navigator.vibrate([200,100,200]);
              setTimeout(dismissRestTimer, 5000);
            } else {
              const m = Math.floor(restTimeRemaining / 60), s = restTimeRemaining % 60;
              document.getElementById('restTimerDisplay').textContent = `${m}:${s.toString().padStart(2,'0')}`;
            }
          }
          tick(); restTimerInterval = setInterval(tick, 1000);
        }
      }
    });

    function renderWorkoutTabs() {
      document.getElementById('workoutTabs').innerHTML = workoutRotation.map((w,i) => `<button class="workout-tab ${i===currentRotationIndex?'active':''}" data-index="${i}">${w}</button>`).join('');
    }

    function renderWorkout() {
      const cw = workoutRotation[currentRotationIndex], wo = workoutData[cw];
      document.getElementById('workoutInfo').innerHTML = `<h2>${wo.name}</h2><p class="subtitle">${wo.subtitle}</p><p class="variant">${wo.variant}</p>`;
      let html = '', i = 0;
      while (i < wo.exercises.length) {
        const ex = wo.exercises[i];
        if (ex.superset) {
          const gid = ex.superset, grouped = [];
          while (i < wo.exercises.length && wo.exercises[i].superset === gid) { grouped.push(wo.exercises[i]); i++; }
          html += `<div class="superset-group"><span class="superset-label">Superset</span>${grouped.map(g => renderExerciseCard(g)).join('')}</div>`;
        } else { html += renderExerciseCard(ex); i++; }
      }
      document.getElementById('exercisesList').innerHTML = html;
      updateProgress();
      document.querySelectorAll('.workout-tab').forEach((t,idx) => t.classList.toggle('active', idx === currentRotationIndex));
    }

    function renderExerciseCard(exercise) {
      const logData = sessionLog[exercise.id] || {}, previousData = getPreviousData(exercise.id);
      let completedSets = 0;
      for (let i = 0; i < exercise.sets; i++) { if (logData[i]?.weight && logData[i]?.reps) completedSets++; }
      const hasPrev = previousData && Object.keys(previousData).length > 0;
      let setsHtml = '';
      for (let i = 0; i < exercise.sets; i++) {
        const sd = logData[i] || {}, pd = previousData?.[i] || {}, ic = sd.weight && sd.reps, hp = pd.weight || pd.reps;
        setsHtml += `<div class="set-row">
          <div class="set-number ${ic?'complete':''} ${hp&&!ic?'has-previous':''}" data-exercise="${exercise.id}" data-set="${i}" data-prev-weight="${pd.weight||''}" data-prev-reps="${pd.reps||''}">${i+1}</div>
          <input type="text" inputmode="decimal" class="set-input ${pd.weight?'has-previous':''}" data-exercise="${exercise.id}" data-set="${i}" data-field="weight" value="${sd.weight||''}" placeholder="${pd.weight||'lbs'}">
          <input type="text" inputmode="decimal" class="set-input ${pd.reps?'has-previous':''}" data-exercise="${exercise.id}" data-set="${i}" data-field="reps" value="${sd.reps||''}" placeholder="${pd.reps||'reps'}">
        </div>`;
      }
      return `<div class="exercise-card" data-exercise-id="${exercise.id}">
        <div class="exercise-header"><div>
          <div class="exercise-title-row"><span class="exercise-name">${exercise.name}</span><button class="tip-btn" data-exercise-id="${exercise.id}">?</button></div>
          <p class="exercise-sets-reps">${exercise.sets} × ${exercise.reps}</p>
        </div><div class="exercise-meta">
          <p class="exercise-rest" data-rest="${exercise.rest}" data-exercise-id="${exercise.id}">⏱ Rest: ${exercise.restLabel}</p>
          <span class="exercise-progress ${completedSets===exercise.sets?'complete':''}">${completedSets}/${exercise.sets}</span>
        </div></div>
        ${exercise.note?`<p class="exercise-note">💡 ${exercise.note}</p>`:''}
        ${hasPrev?'<p class="previous-note">📊 Last time in blue <span class="autofill-hint">· tap # to autofill</span></p>':''}
        <div class="sets-header"><span></span><span>Weight</span><span>Reps</span></div>${setsHtml}</div>`;
    }

    function updateProgress() {
      const wo = workoutData[workoutRotation[currentRotationIndex]];
      let total = 0, done = 0;
      wo.exercises.forEach(ex => { total += ex.sets; const l = sessionLog[ex.id]||{}; for (let i=0;i<ex.sets;i++) if(l[i]?.weight&&l[i]?.reps) done++; });
      document.getElementById('progressBar').style.width = `${total?Math.round(done/total*100):0}%`;
      document.getElementById('progressText').textContent = `${done} / ${total} sets`;
    }

    function getPreviousData(id) { for (const e of history) if (e.exercises[id]) return e.exercises[id]; return null; }

    function renderTechniquesModal() {
      document.getElementById('techniquesModalBody').innerHTML = techniques.map(t => `<div class="technique-card"><h3>${t.name}</h3><p>${t.description}</p><div class="technique-example"><p class="label">Example:</p><p>${t.example}</p></div></div>`).join('') + `<div class="progression-card"><h3>Progressive Overload Tips</h3><ul>${progressionTips.map(t=>`<li>${t}</li>`).join('')}</ul></div>`;
    }

    function renderHistoryModal() {
      const body = document.getElementById('historyModalBody');
      if (!history.length) { body.innerHTML = '<p class="history-empty">No completed workouts yet. Get after it! 💪</p>'; return; }
      body.innerHTML = history.map((entry, idx) => {
        const wo = workoutData[entry.workout];
        const exHtml = Object.entries(entry.exercises).map(([exId, sets]) => {
          const ex = wo?.exercises.find(e=>e.id===exId);
          const se = Object.entries(sets).filter(([_,s])=>s.weight&&s.reps);
          if (!se.length) return '';
          return `<div class="history-exercise"><div class="history-exercise-header"><span class="history-exercise-name">${ex?.name||exId}</span><span class="history-exercise-sets">${se.length} sets ✓</span></div><div class="history-exercise-data">${se.map(([_,s])=>`${s.weight}×${s.reps}`).join(', ')}</div></div>`;
        }).join('');
        const date = new Date(entry.date).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
        return `<div class="history-entry"><div class="history-header"><span class="history-workout">Workout ${entry.workout}</span><div style="display:flex;align-items:center;gap:8px"><span class="history-date">${date}</span><button class="history-delete-btn" data-history-index="${idx}" title="Delete">🗑</button></div></div><p class="history-variant">${wo?.variant||''}</p>${exHtml}</div>`;
      }).join('');
    }

    function renderFinishModal() {
      const cw = workoutRotation[currentRotationIndex], wo = workoutData[cw];
      let total = 0, done = 0; const summaries = [];
      wo.exercises.forEach(ex => {
        const l = sessionLog[ex.id]||{}; let c = 0; const d = [];
        for (let i=0;i<ex.sets;i++) if(l[i]?.weight&&l[i]?.reps) { c++; d.push(`${l[i].weight}×${l[i].reps}`); }
        total += ex.sets; done += c;
        if (c) summaries.push({name:ex.name,detail:d.join(', ')});
      });
      const ni = (currentRotationIndex+1)%workoutRotation.length, nw = workoutRotation[ni];
      document.getElementById('finishModalBody').innerHTML = `<div class="finish-summary-header"><div class="emoji">💪</div><h3>Workout ${cw} — ${wo.name}</h3><p>${wo.variant}</p></div>
        <div class="finish-stat-row"><div class="finish-stat"><div class="value">${done}</div><div class="label">Sets Done</div></div><div class="finish-stat"><div class="value">${total}</div><div class="label">Total Sets</div></div><div class="finish-stat"><div class="value">${summaries.length}</div><div class="label">Exercises</div></div></div>
        ${summaries.map(e=>`<div class="finish-exercise-item"><span class="finish-exercise-name">${e.name}</span><span class="finish-exercise-detail">${e.detail}</span></div>`).join('')}
        <div class="finish-next"><div class="label">Next workout</div><div class="value">${nw} — ${workoutData[nw].variant}</div></div>`;
    }

    function updateSetUI(input) {
      const row = input.closest('.set-row'), sn = row.querySelector('.set-number'), inputs = row.querySelectorAll('.set-input');
      const ic = inputs[0].value && inputs[1].value;
      sn.classList.toggle('complete', ic); if(ic) sn.classList.remove('has-previous');
      const card = input.closest('.exercise-card'), eid = input.dataset.exercise;
      const exData = workoutData[workoutRotation[currentRotationIndex]].exercises.find(e=>e.id===eid);
      const ld = sessionLog[eid]||{}; let c = 0;
      for(let i=0;i<exData.sets;i++) if(ld[i]?.weight&&ld[i]?.reps) c++;
      const p = card.querySelector('.exercise-progress');
      p.textContent = `${c}/${exData.sets}`; p.classList.toggle('complete', c===exData.sets);
      updateProgress();
    }

    function showUndoToast() {
      clearTimeout(undoTimeout);
      document.getElementById('undoToast').classList.add('active');
      undoTimeout = setTimeout(()=>{ hideUndoToast(); clearedBackup = null; }, 5000);
    }
    function hideUndoToast() { clearTimeout(undoTimeout); document.getElementById('undoToast').classList.remove('active'); }
    function openModal(id) { document.getElementById(id).classList.add('active'); document.body.style.overflow = 'hidden'; }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); document.body.style.overflow = ''; }

    function setupEventListeners() {
      document.getElementById('workoutTabs').addEventListener('click', e => {
        if (e.target.classList.contains('workout-tab')) { currentRotationIndex = parseInt(e.target.dataset.index); saveSession(); renderWorkout(); }
      });

      document.getElementById('exercisesList').addEventListener('input', e => {
        if (e.target.classList.contains('set-input')) {
          const {exercise,set,field} = e.target.dataset;
          if(!sessionLog[exercise]) sessionLog[exercise] = {};
          if(!sessionLog[exercise][set]) sessionLog[exercise][set] = {};
          sessionLog[exercise][set][field] = e.target.value;
          saveSession(); updateSetUI(e.target);
        }
      });

      document.getElementById('exercisesList').addEventListener('change', e => {
        if (e.target.classList.contains('set-input')) {
          const {exercise,set} = e.target.dataset, l = sessionLog[exercise]?.[set];
          if (l?.weight && l?.reps) {
            // Timer no longer auto-starts on input; use ⏱ Rest or autofill tap instead
          }
        }
      });

      document.getElementById('exercisesList').addEventListener('click', e => {
        const sn = e.target.closest('.set-number');
        if (sn && sn.classList.contains('has-previous') && !sn.classList.contains('complete')) {
          const eid = sn.dataset.exercise, si = sn.dataset.set, pw = sn.dataset.prevWeight, pr = sn.dataset.prevReps;
          const row = sn.closest('.set-row'), inputs = row.querySelectorAll('.set-input');
          if(pw) inputs[0].value = pw; if(pr) inputs[1].value = pr;
          if(!sessionLog[eid]) sessionLog[eid] = {};
          if(!sessionLog[eid][si]) sessionLog[eid][si] = {};
          if(pw) sessionLog[eid][si].weight = pw; if(pr) sessionLog[eid][si].reps = pr;
          saveSession(); updateSetUI(inputs[0]);
        }

        const tipBtn = e.target.closest('.tip-btn');

        const restLabel = e.target.closest('.exercise-rest');
        if (restLabel) {
          const restSec = parseInt(restLabel.dataset.rest);
          if (restSec > 0) startRestTimer(restSec, true);
        }

        if (tipBtn) {
          const eid = tipBtn.dataset.exerciseId, ex = workoutData[workoutRotation[currentRotationIndex]].exercises.find(e=>e.id===eid);
          if (ex) {
            document.getElementById('tipModalTitle').textContent = ex.name;
            const t = ex.tip;
            document.getElementById('tipModalBody').innerHTML = `<p class="tip-meta">${ex.sets} × ${ex.reps} | Rest: ${ex.restLabel}</p>
              <div class="tip-section setup"><h3>⚙️ Setup</h3><p>${t.setup}</p></div>
              <div class="tip-section execution"><h3>🎯 Execution</h3><p>${t.execution.replace(/\n/g,'<br>')}</p></div>
              <div class="tip-section mistakes"><h3>⚠️ Common Mistakes</h3><ul>${t.mistakes.map(m=>`<li>${m}</li>`).join('')}</ul></div>`;
            openModal('tipModal');
          }
        }
      });

      document.getElementById('restTimerSkip').addEventListener('click', dismissRestTimer);
      document.getElementById('restTimerAdd').addEventListener('click', () => { restTimerEndTime += 30000; restTimeRemaining += 30; });
      document.getElementById('tipsBtn').addEventListener('click', () => openModal('techniquesModal'));
      document.getElementById('historyBtn').addEventListener('click', () => { renderHistoryModal(); openModal('historyModal'); });

      document.getElementById('historyModalBody').addEventListener('click', e => {
        const btn = e.target.closest('.history-delete-btn');
        if (btn && confirm('Delete this workout entry?')) { history.splice(parseInt(btn.dataset.historyIndex),1); saveHistory(); renderHistoryModal(); }
      });

      document.getElementById('clearBtn').addEventListener('click', () => {
        if (!Object.keys(sessionLog).length) return;
        clearedBackup = JSON.parse(JSON.stringify(sessionLog));
        sessionLog = {}; saveSession(); renderWorkout(); showUndoToast();
      });

      document.getElementById('undoBtn').addEventListener('click', () => {
        if (clearedBackup) { sessionLog = clearedBackup; clearedBackup = null; saveSession(); renderWorkout(); hideUndoToast(); }
      });

      document.getElementById('finishBtn').addEventListener('click', () => {
        if (!Object.keys(sessionLog).length) { alert('Log at least one set before finishing!'); return; }
        renderFinishModal(); openModal('finishModal');
      });

      document.getElementById('finishConfirmBtn').addEventListener('click', () => {
        const cw = workoutRotation[currentRotationIndex];
        history = [{ date: new Date().toISOString(), workout: cw, exercises: sessionLog }, ...history].slice(0,100);
        saveHistory(); sessionLog = {};
        try { localStorage.removeItem('currentSession_v3'); } catch(e) {}
        currentRotationIndex = (currentRotationIndex+1)%workoutRotation.length;
        saveSession(); closeModal('finishModal'); renderWorkout();
      });

      document.getElementById('finishCancelBtn').addEventListener('click', () => closeModal('finishModal'));
      document.getElementById('finishModalClose').addEventListener('click', () => closeModal('finishModal'));
      document.getElementById('finishModal').addEventListener('click', e => { if(e.target.id==='finishModal') closeModal('finishModal'); });

      ['tipModal','techniquesModal','historyModal'].forEach(id => {
        const m = document.getElementById(id);
        m.querySelector('.modal-close').addEventListener('click', () => closeModal(id));
        m.querySelector('.modal-footer button').addEventListener('click', () => closeModal(id));
        m.addEventListener('click', e => { if(e.target===m) closeModal(id); });
      });
    }

    init();
  </script>
</body>
</html>
